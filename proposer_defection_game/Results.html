{% extends "global/Page.html" %}
{% load otree %}

{% block title %}Round Results{% endblock %}

{% block content %}

<p><strong>Your Player ID:</strong> {{ player.id_in_group }}</p>
<p><strong>Proposer:</strong> Player {{ group.proposer_id }}</p>

<p><strong>Initial Proposal:</strong> {{ group.proposer_allocation }}</p>

{% if group.majority_accepts %}
    <p style="color:green;"><strong>Majority Accepted</strong></p>
    {% if group.field_maybe_none('final_allocation') %}
        {% if has_defected %}
            <p><strong><span style="color:red;">The proposer has defected</span></strong> <strong>and set a new allocation.</strong></p>
        {% else %}
            <p><strong><span style="color:green;">No defection was made.</span></strong> <strong>All allocation stands as proposed </strong></p>
        {% endif %}
        <!-- Allocation Comparison Table -->
        <table class="table table-bordered">
        <thead>
            <tr>
                <th>Player</th>
                <th>Initial Proposal</th>
                <th>Final Allocation</th>
            </tr>
        </thead>
        <tbody>
            {% for pair in allocation_pairs %}
            <tr {% if forloop.counter == player.id_in_group %}class="table-primary"{% endif %}>
                <td>Player {{ forloop.counter }}</td>
                <td>€{{ pair.0 }}</td>
                <td>€{{ pair.1 }}</td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    {% endif %}
{% else %}
    <p style="color:red;"><strong>Majority Rejected</strong></p>
    <p>All players receive 0 for this round.</p>
{% endif %}

<hr>

<p><strong>Your allocation this round:</strong> {{ player.amount_received }}</p>

{% if all_proposers_done %}
    <h3>All rounds are over!</h3>
    <p>Your final total payoffs when each player acted as the proposer were as follows:</p>
    <ul>
        {% for pid, amt in phase_earnings.items %}
            {% if pid < 5 %}
            <li>Player {{ pid }}: {{ amt }}</li>
            {% endif %}
        {% endfor %}
    </ul>
{% else %}
    <p>Sub-round {{ sub_round }} of {{ sub_rounds }} for proposer Player {{ proposer_id }}</p>
    <div style="text-align: center; margin-top: 20px;">
    <p><strong>Your payoff so far under this proposer:</strong> €{{ phase_total_for_current_proposer }}</p>
{% endif %}

<div style="margin-top:15px;">
    {{ next_button }}
</div>
{% endblock %}
